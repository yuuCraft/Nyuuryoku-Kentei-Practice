<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>入力検定練習ソフト V1.52 Web-Release</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:rgba(255,255,255,.75);
  --text:#111;
  --accent:#2563eb;
  --danger:#dc2626;
  --border:rgba(0,0,0,.12);
  --shadow:0 20px 40px rgba(0,0,0,.12);
  --ok:#16a34a;
  --miss:#dc2626;
  --none:#9ca3af;
}

/* Win11 Dark + Mica */
.dark{
  --bg:#0f1115;
  --card:rgba(28,31,38,.7);
  --text:#e5e7eb;
  --accent:#60a5fa;
  --border:rgba(255,255,255,.12);
  --shadow:0 25px 60px rgba(0,0,0,.7);
}

*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
  color:var(--text);
}

/* ===== Header ===== */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:1rem 1.2rem;
  border-bottom:1px solid var(--border);
  backdrop-filter: blur(18px) saturate(140%);
  background:linear-gradient(
    180deg,
    rgba(255,255,255,.65),
    rgba(255,255,255,.35)
  );
}
.dark header{
  background:linear-gradient(
    180deg,
    rgba(30,41,59,.7),
    rgba(17,24,39,.5)
  );
}

/* ← タイトル小さく */
h1{
  font-size:1rem;
  font-weight:600;
  margin:0;
}

/* ===== Layout ===== */
.container{
  max-width:1100px;
  margin:1.6rem auto;
  padding:0 1rem;
}

.card{
  background:var(--card);
  backdrop-filter: blur(22px) saturate(160%);
  border-radius:16px;
  box-shadow:var(--shadow);
  padding:1.2rem;
  margin-bottom:1rem;
  border:1px solid var(--border);
}

/* ===== Buttons ===== */
button{
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  padding:.55rem .9rem;
  border-radius:10px;
  cursor:pointer;
}
button.primary{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}
button.blue{
  border:2px solid var(--accent);
  color:var(--accent);
}
button.danger{
  background:var(--danger);
  color:#fff;
}

/* ===== Textarea ===== */
textarea{
  width:100%;
  min-height:220px;
  padding:1rem;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:1rem;
  background:rgba(255,255,255,.6);
}
.dark textarea{
  background:rgba(17,24,39,.7);
  color:#e5e7eb;
}

/* ===== Grid ===== */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}
@media(max-width:800px){
  .grid{grid-template-columns:1fr}
}

/* ===== Timer / Compare ===== */
.timer{
  font-size:2.3rem;
  font-weight:800;
}
.score{
  font-size:2.4rem;
  font-weight:800;
  text-align:center;
}
.diff{
  margin-top:.75rem;
  font-family:monospace;
  white-space:pre-wrap;
}
.ok{color:var(--ok)}
.miss{color:var(--miss)}
.none{color:var(--none)}
</style>
</head>

<body>

<header>
  <h1>入力検定練習ソフト V1.50 Web</h1>
  <label>
    <input type="checkbox" id="darkToggle"> ダークモード
  </label>
</header>

<div class="container">

<div class="card">
  <button id="saveTxtBtn" class="blue">TXT保存</button>
  <button id="saveWebBtn" class="blue">Web保存</button>
  <button id="lockBtn">ロック</button>
  <span id="lockState">未ロック</span>
  <button id="clearBtn" class="danger">削除</button>
</div>

<div class="card">
  <textarea id="inputArea" placeholder="ここに入力…"></textarea>
  <div style="margin-top:.5rem">
    文字数：<span id="chars">0</span>　
    行数：<span id="lines">0</span>
  </div>
</div>

<div class="grid">

<div class="card">
  <h3>＝タイマー＝</h3>
  <div class="timer" id="timerLabel">00:00:00</div>
  <input id="h" type="number" value="0" style="width:4rem">時
  <input id="m" type="number" value="1" style="width:4rem">分
  <input id="s" type="number" value="0" style="width:4rem">秒
  <div style="margin-top:.5rem">
    <button id="start" class="primary">開始</button>
    <button id="pause">停止</button>
    <button id="reset">リセット</button>
  </div>
</div>

<div class="card">
  <h3>＝比較＝</h3>
  <textarea id="refArea" placeholder="お手本文章"></textarea>
  <button id="compare" class="primary">比較</button>
  <div id="score" class="score">—</div>
  <div id="diff" class="diff"></div>
</div>

</div>
</div>

<audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
/* ===== Count ===== */
const input=inputArea, ref=refArea;
function count(){
  chars.textContent=input.value.length;
  lines.textContent=input.value.split("\n").length;
}
input.oninput=count;count();

/* ===== Dark ===== */
darkToggle.onchange=e=>{
  document.documentElement.classList.toggle("dark",e.target.checked);
  localStorage.setItem("dark",e.target.checked?1:0);
};
if(localStorage.getItem("dark")==="1"){
  document.documentElement.classList.add("dark");
  darkToggle.checked=true;
}

/* ===== Web保存（修正済） ===== */
const KEY="typingToolSave";
saveWebBtn.onclick=()=>{
  localStorage.setItem(KEY,JSON.stringify({
    i:input.value,
    r:ref.value
  }));
  alert("Web保存しました");
};
(()=>{
  const d=localStorage.getItem(KEY);
  if(d){
    const j=JSON.parse(d);
    input.value=j.i||"";
    ref.value=j.r||"";
    count();
  }
})();

/* ===== TXT保存 ===== */
saveTxtBtn.onclick=()=>{
  const b=new Blob([input.value],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="typing.txt";
  a.click();
};

/* ===== Lock ===== */
let lock=false;
lockBtn.onclick=()=>{
  lock=!lock;
  input.readOnly=lock;
  ref.readOnly=lock;
  lockState.textContent=lock?"ロック中":"未ロック";
};

/* ===== Clear ===== */
clearBtn.onclick=()=>{
  if(confirm("削除しますか？")){
    input.value="";ref.value="";
    localStorage.removeItem(KEY);
    count();
  }
};

/* ===== Timer + Alarm ===== */
let rest=0,run=false,raf;
function fmt(ms){
  let t=ms/1000|0;
  return `${String(t/3600|0).padStart(2,"0")}:${String(t%3600/60|0).padStart(2,"0")}:${String(t%60).padStart(2,"0")}`;
}
function set(){
  rest=(+h.value*3600+ +m.value*60+ +s.value)*1000;
  timerLabel.textContent=fmt(rest);
}
[h,m,s].forEach(i=>i.onchange=set);set();
start.onclick=()=>{
  if(run)return;run=true;
  const end=performance.now()+rest;
  const tick=t=>{
    rest=Math.max(0,end-t);
    timerLabel.textContent=fmt(rest);
    if(rest>0) raf=requestAnimationFrame(tick);
    else{run=false;alarm.play();}
  };
  raf=requestAnimationFrame(tick);
};
pause.onclick=()=>{run=false;cancelAnimationFrame(raf)};
reset.onclick=()=>{pause();set();};

/* ===== Compare ===== */
compare.onclick=()=>{
  let out="",miss=0;
  const a=input.value,b=ref.value;
  for(let i=0;i<Math.max(a.length,b.length);i++){
    if(a[i]===b[i]) out+=`<span class="ok">${b[i]||" "}</span>`;
    else{out+=`<span class="miss">${b[i]||" "}</span>`;miss++;}
  }
  diff.innerHTML=out;
  score.textContent=miss;
};
</script>

</body>
</html>
